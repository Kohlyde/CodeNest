<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Codenest â€¢ Private Local Vault</title>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/material-darker.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closetag.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/selection/active-line.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/display/placeholder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/htmlmixed/htmlmixed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/sass/sass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/perl/perl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/shell/shell.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/ruby/ruby.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/php/php.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/go/go.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/clike/clike.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/rust/rust.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/sql/sql.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/yaml/yaml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/vue/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.0/dist/split.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sass.js@0.11.1/dist/sass.sync.js"></script>
    <style>
        :root {
            --lion: #ae9461;
            --night: #0d0d0d;
            --black: #030303;
            --garnet: #642b2b;
            --white: #ffffff;
            --ink: #d6d6d6;
            --ink-d: #aaa;
            --card: #121212;
            --card2: #151515;
            --edge: #1a1a1a;
            --accent: var(--lion)
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--night);
            color: var(--white);
            font-family: "DejaVu Sans", "Bitstream Vera Sans", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden
        }

        a {
            color: var(--accent)
        }

        .hidden {
            display: none !important
        }

        .app {
            display: grid;
            grid-template-rows: auto 1fr;
            min-height: 100vh
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: .6rem .9rem;
            border-bottom: 1px solid var(--edge);
            background: linear-gradient(180deg, #0f0f0f, #0a0a0a)
        }

        .brand {
            display: flex;
            align-items: center;
            gap: .6rem;
            font-weight: 700;
            letter-spacing: .3px
        }

        .brand .logo {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: conic-gradient(from 180deg, var(--lion), #bda678, var(--garnet), #333);
            display: grid;
            place-items: center;
            color: #000
        }

        .chip {
            background: #101010;
            border: 1px solid var(--edge);
            padding: .25rem .5rem;
            border-radius: 999px;
            color: var(--ink);
            font-size: .8rem
        }

        .toolbar {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: .5rem;
            margin-left: auto
        }

        .toolbar .group {
            display: flex;
            align-items: center;
            gap: .5rem;
            background: var(--card);
            border: 1px solid var(--edge);
            padding: .35rem .5rem;
            border-radius: 10px
        }

        .toolbar label {
            color: var(--ink);
            font-size: .85rem
        }

        .btn {
            background: var(--card2);
            border: 1px solid var(--edge);
            color: #eee;
            padding: .45rem .65rem;
            border-radius: 10px;
            cursor: pointer;
            transition: transform .08s ease, box-shadow .2s
        }

        .btn:hover {
            box-shadow: 0 0 0 1px var(--edge), 0 6px 20px rgba(0, 0, 0, .35)
        }

        .btn:active {
            transform: translateY(1px)
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(260px, 1fr) 4fr;
            gap: 8px;
            padding: 8px;
            height: calc(100vh - 58px)
        }

        .left,
        .right {
            background: var(--black);
            border: 1px solid var(--edge);
            border-radius: 12px;
            overflow: hidden
        }

        .left {
            display: flex;
            flex-direction: column
        }

        .left-head {
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: .6rem .75rem;
            border-bottom: 1px solid var(--edge);
            background: var(--card)
        }

        .left-scroll {
            overflow: auto;
            padding: .6rem;
            display: grid;
            gap: .6rem
        }

        .panel {
            border: 1px solid var(--edge);
            background: var(--card2);
            border-radius: 12px;
            overflow: hidden
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .4rem .6rem;
            border-bottom: 1px solid var(--edge);
            background: #111
        }

        .panel-head .meta {
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: .35rem
        }

        .panel-actions .btn {
            padding: .25rem .45rem;
            font-size: .9rem
        }

        .panel-body {
            height: 220px
        }

        .CodeMirror {
            height: 100%;
            font-size: 13px;
            background: #0e0e0e
        }

        .right {
            display: grid;
            grid-template-rows: auto 1fr auto
        }

        .right-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .6rem .75rem;
            border-bottom: 1px solid var(--edge);
            background: var(--card)
        }

        .preview-wrap {
            position: relative
        }

        .preview {
            width: 100%;
            height: 100%;
            border: 0;
            background: #fff
        }

        .console {
            max-height: 140px;
            overflow: auto;
            border-top: 1px solid var(--edge);
            background: #0b0b0b;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            padding: .5rem
        }

        .log {
            padding: .2rem .25rem;
            color: #cfcfcf;
            border-left: 3px solid transparent
        }

        .log.info {
            border-color: #3a7
        }

        .log.warn {
            border-color: #c93;
            color: #f4d99b
        }

        .log.error {
            border-color: #e55;
            color: #ffbdbd
        }

        .preset-classic .layout {
            grid-template-columns: minmax(260px, 20%) 1fr
        }

        .preset-stacked .layout {
            grid-template-rows: 55% 45%;
            grid-template-columns: 1fr
        }

        .preset-stacked .left {
            grid-row: 1
        }

        .preset-stacked .right {
            grid-row: 2
        }

        .preset-columns .layout {
            grid-template-columns: 40% 60%
        }

        .resizer {
            width: 6px;
            background: linear-gradient(180deg, #111, #161616);
            cursor: col-resize
        }

        .kbd {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            font-size: .8rem;
            background: #121212;
            border: 1px solid var(--edge);
            padding: .05rem .35rem;
            border-radius: 6px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .25rem .5rem;
            border-radius: 999px;
            background: #0f0f0f;
            border: 1px dashed var(--edge);
            color: var(--ink)
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 10
        }

        .modal.open {
            display: flex
        }

        .modal .card {
            background: var(--card);
            border: 1px solid var(--edge);
            border-radius: 14px;
            max-width: 820px;
            width: 100%;
            padding: 1rem
        }

        .modal .card h3 {
            margin: .1rem 0 1rem 0
        }

        .form {
            display: grid;
            gap: .6rem
        }

        .form label {
            font-size: .9rem;
            color: var(--ink)
        }

        .form input,
        .form select,
        .form textarea {
            width: 100%;
            background: #0e0e0e;
            border: 1px solid var(--edge);
            color: #eee;
            border-radius: 10px;
            padding: .5rem
        }

        .row {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap
        }

        .row .flex {
            flex: 1
        }

        .hint {
            color: var(--ink);
            font-size: .85rem
        }

        .full {
            position: fixed;
            inset: 0;
            display: none
        }

        .full.active {
            display: grid;
            grid-template-rows: auto 1fr
        }

        .page-head {
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: .75rem .9rem;
            border-bottom: 1px solid var(--edge);
            background: linear-gradient(180deg, #0f0f0f, #0a0a0a)
        }

        .page-body {
            overflow: auto;
            padding: 1rem;
            display: grid;
            gap: .9rem
        }

        .card {
            background: var(--card);
            border: 1px solid var(--edge);
            border-radius: 14px;
            padding: 1rem
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .75rem
        }

        .grid3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: .75rem
        }

        @media(max-width:980px) {

            .grid2,
            .grid3 {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body class="app preset-classic">
    <div id="page-consent" class="full active">
        <div class="page-head">
            <div class="brand">
                <div class="logo"><i class="fa-solid fa-lock"></i></div>Codenest <span class="chip">App Approval</span>
            </div>
        </div>
        <div class="page-body">
            <div class="card">
                <h3><i class="fa-solid fa-shield"></i> Local Storage Permission</h3>
                <div class="form">
                    <p>This app stores everything <b>locally</b> in your browser. Choose how you want data to persist.
                    </p>
                    <div class="grid3"><button id="consent-persist" class="btn"><i class="fa-solid fa-hard-drive"></i>
                            Allow persistent storage</button><button id="consent-session" class="btn"><i
                                class="fa-solid fa-hourglass"></i> Session only</button><button id="consent-deny"
                            class="btn"><i class="fa-solid fa-ban"></i> Deny (ephemeral)</button></div>
                    <p class="hint">No servers. No tracking. You can change this later in Settings.</p>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-user-plus"></i> Continue</h3>
                <div><button id="to-auth" class="btn"><i class="fa-solid fa-arrow-right-to-bracket"></i> Proceed to
                        Account</button></div>
            </div>
        </div>
    </div>
    <div id="page-auth" class="full">
        <div class="page-head">
            <div class="brand">
                <div class="logo"><i class="fa-solid fa-user-shield"></i></div>Codenest <span class="chip">Sign
                    In</span>
            </div>
        </div>
        <div class="page-body">
            <div class="grid2">
                <div class="card">
                    <h3><i class="fa-solid fa-door-open"></i> Login</h3>
                    <div class="form"><label>Username</label><input id="login-user" autocomplete="username"
                            placeholder="username"><label>Password</label><input id="login-pass" type="password"
                            autocomplete="current-password" placeholder="password">
                        <div class="row"><button id="login-btn" class="btn"><i class="fa-solid fa-right-to-bracket"></i>
                                Login</button><button id="auth-to-register" class="btn"><i
                                    class="fa-solid fa-user-plus"></i> Register</button></div>
                        <div id="auth-msg" class="hint"></div>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fa-solid fa-user-plus"></i> Create Account</h3>
                    <div class="form"><label>Username</label><input id="reg-user" autocomplete="username"
                            placeholder="username"><label>Password</label><input id="reg-pass" type="password"
                            autocomplete="new-password" placeholder="password"><label>Confirm Password</label><input
                            id="reg-pass2" type="password" autocomplete="new-password" placeholder="confirm password">
                        <div class="row"><button id="register-btn" class="btn"><i class="fa-solid fa-circle-check"></i>
                                Create</button></div>
                        <div class="hint">Password-derived encryption protects your vault. Keep your password safe; it
                            cannot be recovered.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="page-app" class="full">
        <div class="topbar">
            <div class="brand">
                <div class="logo"><i class="fa-solid fa-code"></i></div>Codenest <span class="chip">Private Vault</span>
            </div>
            <div class="toolbar">
                <div class="group"><label>Layout</label><select id="layoutSelect">
                        <option value="classic">Classic (Left â†’ Right)</option>
                        <option value="columns">Columns (40/60)</option>
                        <option value="stacked">Stacked</option>
                        <option value="custom">Custom (drag)</option>
                    </select></div>
                <div class="group"><label><input type="checkbox" checked id="toggleAll"> All</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="html" checked> HTML</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="css" checked> CSS</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="js" checked> JS</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="svg"> SVG</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="scss"> SCSS</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="md"> MD</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="py"> Python</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="rb"> Ruby</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="php"> PHP</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="sql"> SQL</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="yaml"> YAML</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="json"> JSON</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="ts"> TS</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="java"> Java</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="cpp"> C/C++</label><label><input
                            type="checkbox" class="toggle-panel" data-panel="rust"> Rust</label></div>
                <div class="group"><button class="btn" id="runBtn" title="Run (Ctrl/Cmd+Enter)"><i
                            class="fa-solid fa-play"></i> Run</button><label><input type="checkbox" id="autoRun">
                        Auto-run</label></div>
                <div class="group"><button class="btn" id="saveBtn" title="Save (Ctrl/Cmd+S)"><i
                            class="fa-solid fa-floppy-disk"></i> Save</button><button class="btn" id="projectsBtn"
                        title="Projects"><i class="fa-solid fa-diagram-project"></i> Projects</button><button
                        class="btn" id="zipBtn" title="Export ZIP"><i class="fa-solid fa-file-zipper"></i>
                        Export</button><button class="btn" id="shareBtn" title="Share current project"><i
                            class="fa-solid fa-share-nodes"></i> Share</button></div>
                <div class="group"><button class="btn" id="nav-settings"><i class="fa-solid fa-gear"></i>
                        Settings</button><button class="btn" id="nav-account"><i class="fa-solid fa-user"></i>
                        Account</button><button class="btn" id="logoutBtn"><i
                            class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button></div>
                <div class="group" title="Hints"><span class="pill"><i class="fa-solid fa-keyboard"></i> <span
                            class="kbd">Ctrl/Cmd+S</span> save â€¢ <span class="kbd">Ctrl/Cmd+Enter</span> run</span>
                </div>
            </div>
        </div>
        <div class="layout" id="layoutRoot">
            <div class="left" id="leftCol">
                <div class="left-head">
                    <div class="title"><i class="fa-solid fa-sliders"></i> Editors</div>
                </div>
                <div class="left-scroll" id="panels"></div>
            </div>
            <div class="right" id="rightCol">
                <div class="right-head">
                    <div class="title"><i class="fa-solid fa-display"></i> Preview</div>
                    <div><button class="btn" id="openInNew"><i class="fa-solid fa-up-right-from-square"></i> New
                            Tab</button></div>
                </div>
                <div class="preview-wrap"><iframe class="preview" id="preview" referrerpolicy="no-referrer"
                        sandbox="allow-scripts allow-same-origin"></iframe></div>
                <div class="console" id="console"></div>
            </div>
        </div>
    </div>
    <div class="modal" id="projectsModal">
        <div class="card">
            <h3><i class="fa-solid fa-diagram-project"></i> Projects</h3>
            <div class="form">
                <div class="row">
                    <div class="flex"><label>Name</label><input id="projName" placeholder="Untitled Project"></div>
                    <div><label> </label><button class="btn" id="projSave">Save</button></div>
                </div>
                <div class="row">
                    <div class="flex"><label>Saved Projects</label><select id="projList" size="6"
                            style="height:160px"></select></div>
                    <div style="display:flex;flex-direction:column;gap:.4rem;justify-content:flex-end"><button
                            class="btn" id="projLoad">Load</button><button class="btn"
                            id="projDup">Duplicate</button><button class="btn" id="projDel">Delete</button><button
                            class="btn" id="projExport">Export JSON</button><label class="btn" for="projImportInput"
                            style="cursor:pointer"><i class="fa-solid fa-file-import"></i> Import JSON</label><input
                            type="file" id="projImportInput" accept="application/json" hidden></div>
                </div>
                <div class="hint">Autosave is on. Data is inside your encrypted vault unless you switched to
                    session/ephemeral mode.</div>
                <div style="text-align:right"><button class="btn" data-close="projectsModal">Close</button></div>
            </div>
        </div>
        <div class="modal" id="settingsModal">
            <div class="card">
                <h3><i class="fa-solid fa-gear"></i> Settings</h3>
                <div class="form"><label>Theme</label><select id="themeSel">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select><label>Storage Mode</label><select id="storageMode">
                        <option value="persist">Persistent (localStorage)</option>
                        <option value="session">Session (sessionStorage)</option>
                        <option value="memory">Ephemeral (memory)</option>
                    </select><label><input type="checkbox" id="gateExternal"> Allow external sync (Backups)</label>
                    <div class="hint">External sync = explicit user-selected backup folder via your OS (works with
                        Drive/OneDrive/iCloud if that folder is synced). Nothing is sent anywhere unless you choose a
                        folder.</div><label><input type="checkbox" id="disabledToggle"> Disable this account (blocks
                        login)</label>
                    <div style="text-align:right"><button class="btn" data-close="settingsModal">Close</button></div>
                </div>
            </div>
        </div>
        <div class="modal" id="accountModal">
            <div class="card">
                <h3><i class="fa-solid fa-user"></i> Account & Vault</h3>
                <div class="form">
                    <div class="row"><button class="btn" id="exportVault"><i class="fa-solid fa-cloud-arrow-down"></i>
                            Export Encrypted Vault (.json)</button><label class="btn" for="importVaultFile"
                            style="cursor:pointer"><i class="fa-solid fa-cloud-arrow-up"></i> Import Encrypted
                            Vault</label><input id="importVaultFile" type="file" accept="application/json" hidden></div>
                    <div class="row">
                        <div class="flex"><label><i class="fa-solid fa-folder-tree"></i> Backup Folder (File System
                                Access)</label>
                            <div class="row"><button class="btn" id="connectBackup"><i class="fa-solid fa-plug"></i>
                                    Connect</button><button class="btn" id="backupNow"><i
                                        class="fa-solid fa-rotate"></i> Backup Now</button><label
                                    style="display:flex;align-items:center;gap:.4rem"><input type="checkbox"
                                        id="autoBackup"> Auto-backup on save</label></div>
                            <div id="backupStatus" class="hint"></div>
                        </div>
                    </div><label>Danger Zone</label>
                    <div class="row"><button class="btn" id="deleteAccount" style="border-color:#642b2b;color:#fbb"><i
                                class="fa-solid fa-skull"></i> Delete Account</button></div>
                    <div class="hint">Exports/backups are encrypted with your password. To use on another device, import
                        and login with the same username/password.</div>
                    <div style="text-align:right"><button class="btn" data-close="accountModal">Close</button></div>
                </div>
            </div>
        </div>
        <script>
            /** qs */
            const qs = (s, sc = document) => sc.querySelector(s); /** qsa */
            const qsa = (s, sc = document) => Array.from(sc.querySelectorAll(s)); /** on */
            const on = (el, ev, fn) => el.addEventListener(ev, fn); /** state */
            let App = {
                user: null,
                key: null,
                consent: 'unknown',
                store: 'localStorage',
                memory: {},
                vault: {
                    projects: [],
                    current: null,
                    settings: {
                        theme: 'dark',
                        layout: 'classic',
                        panels: ['html', 'css', 'js'],
                        gateExternal: false,
                        disabled: false,
                        autoBackup: false
                    }
                },
                backup: {
                    dir: null,
                    capable: !!window.showDirectoryPicker
                }
            }; /** storage impl */
            const Stores = {
                persist: localStorage,
                session: sessionStorage
            }; /** getStore */
            const getStore = () => App.store === 'memory' ? null : (App.store === 'session' ? Stores.session : Stores
                .persist); /** kvGet */
            const kvGet = (k) => {
                try {
                    if (App.store === 'memory') return App.memory[k] || null;
                    const s = getStore();
                    return s.getItem(k)
                } catch {
                    return null
                }
            }; /** kvSet */
            const kvSet = (k, v) => {
                try {
                    if (App.store === 'memory') {
                        App.memory[k] = v;
                        return
                    }
                    const s = getStore();
                    s.setItem(k, v)
                } catch {}
            }; /** kvDel */
            const kvDel = (k) => {
                try {
                    if (App.store === 'memory') {
                        delete App.memory[k];
                        return
                    }
                    const s = getStore();
                    s.removeItem(k)
                } catch {}
            }; /** uid */
            const uid = () => ('u_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8)); /** enc: utils */
            const enc = new TextEncoder();
            const dec = new TextDecoder(); /** sha */
            const sha = async (b) => {
                const a = await crypto.subtle.digest('SHA-256', b);
                return new Uint8Array(a)
            }; /** pbkdf2 */
            const deriveKey = async (pass, salt, it = 120000) => {
                const base = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, [
                    'deriveKey'
                ]);
                return crypto.subtle.deriveKey({
                    name: 'PBKDF2',
                    salt,
                    iterations: it,
                    hash: 'SHA-256'
                }, base, {
                    name: 'AES-GCM',
                    length: 256
                }, false, ['encrypt', 'decrypt'])
            }; /** aead enc */
            const aeadEnc = async (key, bytes) => {
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const ct = await crypto.subtle.encrypt({
                    name: 'AES-GCM',
                    iv
                }, key, bytes);
                return {
                    iv: Array.from(iv),
                    ct: Array.from(new Uint8Array(ct))
                }
            }; /** aead dec */
            const aeadDec = async (key, iv, ct) => {
                const buf = new Uint8Array(ct);
                const ivu = new Uint8Array(iv);
                const pt = await crypto.subtle.decrypt({
                    name: 'AES-GCM',
                    iv: ivu
                }, key, buf);
                return new Uint8Array(pt)
            }; /** vaultKey */
            const vaultKey = (u) => `cn.vault.${u}`; /** usersKey */
            const usersKey = () => `cn.users.index`; /** loadUsers */
            const loadUsers = () => {
                try {
                    return JSON.parse(kvGet(usersKey()) || '[]')
                } catch {
                    return []
                }
            }; /** saveUsers */
            const saveUsers = (arr) => kvSet(usersKey(), JSON.stringify(arr)); /** findUser */
            const findUser = (u) => loadUsers().find(x => x.user === u) || null; /** putUser */
            const putUser = (meta) => {
                const all = loadUsers().filter(x => x.user !== meta.user);
                all.push(meta);
                saveUsers(all)
            }; /** consent load */
            const loadConsent = () => {
                const c = kvGet('cn.app.consent');
                if (c) {
                    App.consent = c;
                    App.store = c === 'persist' ? 'persist' : (c === 'session' ? 'session' : 'memory')
                } else {
                    App.consent = 'unknown';
                    App.store = 'persist'
                }
            }; /** setConsent */
            const setConsent = (mode) => {
                App.consent = mode;
                App.store = mode === 'persist' ? 'persist' : (mode === 'session' ? 'session' : 'memory');
                kvSet('cn.app.consent', mode)
            }; /** route */
            const route = (id) => {
                qsa('.full').forEach(p => p.classList.remove('active'));
                qs('#' + id).classList.add('active')
            }; /** toast */
            let toastTimer;
            const toast = (msg) => {
                clearTimeout(toastTimer);
                let el = qs('#toast');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'toast';
                    document.body.appendChild(el);
                    Object.assign(el.style, {
                        position: 'fixed',
                        left: '50%',
                        bottom: '20px',
                        transform: 'translateX(-50%)',
                        background: '#111',
                        border: '1px solid #333',
                        padding: '8px 12px',
                        borderRadius: '10px',
                        color: '#eee',
                        zIndex: 9999,
                        boxShadow: '0 10px 30px rgba(0,0,0,.4)'
                    });
                }
                el.textContent = msg;
                el.style.opacity = '1';
                toastTimer = setTimeout(() => el.style.opacity = '0', 1800)
            }; /** ---------- IndexedDB for handles ---------- */
            const idbOpen = () => new Promise((res, rej) => {
                const r = indexedDB.open('codenest', 1);
                r.onupgradeneeded = () => {
                    r.result.createObjectStore('kv')
                };
                r.onsuccess = () => res(r.result);
                r.onerror = () => rej(r.error)
            }); /** idbSet */
            const idbSet = async (k, v) => {
                try {
                    const db = await idbOpen();
                    const tx = db.transaction('kv', 'readwrite');
                    tx.objectStore('kv').put(v, k);
                    await tx.complete
                } catch {}
            }; /** idbGet */
            const idbGet = async (k) => {
                try {
                    const db = await idbOpen();
                    return await new Promise((res) => {
                        const tx = db.transaction('kv');
                        const req = tx.objectStore('kv').get(k);
                        req.onsuccess = () => res(req.result || null);
                        req.onerror = () => res(null)
                    })
                } catch {
                    return null
                }
            }; /** idbDel */
            const idbDel = async (k) => {
                try {
                    const db = await idbOpen();
                    const tx = db.transaction('kv', 'readwrite');
                    tx.objectStore('kv').delete(k);
                    await tx.complete
                } catch {}
            }; /** ---------- Account & Vault ---------- */
            const createAccount = async (u, p) => {
                if (!u || !p) throw new Error('username/password required');
                if (findUser(u)) throw new Error('user exists');
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const key = await deriveKey(p, salt);
                const verify = Array.from(await sha(enc.encode(u)));
                const meta = {
                    user: u,
                    salt: Array.from(salt),
                    iter: 120000,
                    verify,
                    disabled: false
                };
                putUser(meta);
                const emptyVault = enc.encode(JSON.stringify(App.vault));
                const sealed = await aeadEnc(key, emptyVault);
                kvSet(vaultKey(u), JSON.stringify(sealed));
                return true
            }; /** login */
            const login = async (u, p) => {
                const m = findUser(u);
                if (!m) throw new Error('not found');
                if (m.disabled) throw new Error('account disabled');
                const salt = new Uint8Array(m.salt);
                const key = await deriveKey(p, salt, m.iter || 120000);
                const sealedRaw = kvGet(vaultKey(u));
                if (!sealedRaw) throw new Error('no vault');
                const sealed = JSON.parse(sealedRaw);
                const plain = await aeadDec(key, sealed.iv, sealed.ct).catch(() => {
                    throw new Error('bad password')
                });
                const vault = JSON.parse(dec.decode(plain));
                App.user = u;
                App.key = key;
                App.vault = vault;
                return true
            }; /** saveVault */
            const saveVault = async () => {
                if (!App.user || !App.key) return;
                const bytes = enc.encode(JSON.stringify(App.vault));
                const sealed = await aeadEnc(App.key, bytes);
                kvSet(vaultKey(App.user), JSON.stringify(sealed));
                if (App.vault.settings.autoBackup) backupIfPossible('autosave')
            }; /** disableUser */
            const disableUser = (u, val) => {
                const m = findUser(u);
                if (!m) return;
                m.disabled = !!val;
                putUser(m)
            }; /** exportEncrypted */
            const exportEncrypted = () => {
                if (!App.user) return;
                const blob = new Blob([kvGet(vaultKey(App.user)) || '{}'], {
                    type: 'application/json'
                });
                saveAs(blob, `${App.user}.codenest.vault.json`)
            }; /** importEncrypted */
            const importEncrypted = async (file) => {
                if (!App.user) return;
                const text = await file.text();
                try {
                    JSON.parse(text)
                } catch {
                    throw new Error('invalid vault json')
                };
                kvSet(vaultKey(App.user), text);
                toast('Vault imported. Re-login required.')
            }; /** logout */
            const logout = () => {
                App.user = null;
                App.key = null;
                route('page-auth')
            }; /** themeApply */
            const themeApply = (t) => {
                if (t === 'light') {
                    document.body.style.background = '#f6f6f6';
                    document.body.style.color = '#111'
                } else {
                    document.body.style.background = 'var(--night)';
                    document.body.style.color = 'var(--white)'
                }
            }; /** ---------- Backup (File System Access) ---------- */
            const backupKey = () => `cn.backup.${App.user}`;
            const describeHandle = async (h) => {
                try {
                    const p = await h.queryPermission({
                        mode: 'readwrite'
                    });
                    return p === 'granted' ? 'granted' : p === 'prompt' ? 'prompt' : 'denied'
                } catch {
                    return 'unsupported'
                }
            };
            const connectBackup = async () => {
                if (!App.user) {
                    toast('Login first');
                    return
                }
                if (!App.backup.capable) {
                    toast('Browser lacks folder access; use Export');
                    return
                }
                try {
                    const dir = await window.showDirectoryPicker({
                        mode: 'readwrite'
                    });
                    const perm = await describeHandle(dir);
                    if (perm !== 'granted') {
                        toast('Permission denied');
                        return
                    }
                    App.backup.dir = dir;
                    await idbSet(backupKey(), dir);
                    qs('#backupStatus').textContent = 'Backup folder connected.';
                    toast('Backup folder connected')
                } catch (e) {
                    toast('Backup canceled')
                }
            };
            const ensureBackupLoaded = async () => {
                if (!App.user || !App.backup.capable) return;
                try {
                    if (App.backup.dir) return;
                    const h = await idbGet(backupKey());
                    if (h) {
                        const p = await describeHandle(h);
                        if (p === 'granted') {
                            App.backup.dir = h;
                            qs('#backupStatus').textContent = 'Backup folder connected.'
                        } else {
                            qs('#backupStatus').textContent = 'Backup folder needs reauthorization.'
                        }
                    }
                } catch {}
            };
            const writeFile = async (dir, name, blob) => {
                const fh = await dir.getFileHandle(name, {
                    create: true
                });
                const ws = await fh.createWritable();
                await ws.write(blob);
                await ws.close()
            };
            const backupNow = async () => {
                if (!App.user) {
                    toast('Login first');
                    return
                }
                if (!App.backup.dir) {
                    toast('Connect backup folder');
                    return
                }
                try {
                    const sealed = kvGet(vaultKey(App.user)) || '{}';
                    const manifest = {
                        user: App.user,
                        verify: (findUser(App.user) || {}).verify || [],
                        ts: Date.now(),
                        algo: 'AES-GCM-256/PBKDF2'
                    };
                    await writeFile(App.backup.dir, `${App.user}.codenest.vault.json`, new Blob([sealed], {
                        type: 'application/json'
                    }));
                    await writeFile(App.backup.dir, `${App.user}.codenest.manifest.json`, new Blob([JSON
                        .stringify(manifest, null, 2)
                    ], {
                        type: 'application/json'
                    }));
                    qs('#backupStatus').textContent = 'Last backup: just now';
                    toast('Backup complete')
                } catch (e) {
                    toast('Backup failed')
                }
            };
            const backupIfPossible = (why) => {
                if (App.vault.settings.autoBackup && App.backup.dir) backupNow().catch(() => {})
            }; /** ---------- Editors & UI ---------- */
            let editors = new Map();
            const defaultSnippets = {
                html: `<!-- HTML -->\n<div class="wrap">\n  <h1>Hello, Codenest ðŸ‘‹</h1>\n  <p>Edit HTML, CSS, JS on the left. Preview on the right.</p>\n  <button id="ping">Ping</button>\n</div>`,
                css: `/* CSS */\n:root{ --accent:#ae9461; }\n*{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;}\n.wrap{padding:2rem} h1{color:var(--accent);font-weight:800;letter-spacing:.4px}\nbutton{background:var(--accent);border:0;color:#111;padding:.6rem .9rem;border-radius:10px;cursor:pointer}\nbutton:hover{filter:brightness(1.05)}`,
                js: `// JS\nconsole.log('Codenest ready');\ndocument.addEventListener('click',e=>{if(e.target.id==='ping'){console.log('pong!');alert('pong!')}});`,
                svg: `<!-- Optional SVG (inline into body) -->\n<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">\n  <circle cx="40" cy="40" r="36" fill="#ae9461" opacity=".2"/>\n  <path d="M20 42 L38 58 L60 24" fill="none" stroke="#ae9461" stroke-width="6" stroke-linecap="round"/>\n</svg>`,
                scss: `// SCSS (compiled & appended to CSS)\n$accent:#ae9461;\n.btn{background:$accent;&:hover{filter:brightness(1.06);}}`,
                md: `# Markdown\n\n**Hello** *world*!`,
                py: `print('hello from python')`,
                rb: `puts 'hello from ruby'`,
                php: `<?php echo 'hello'; ?>`,
                sql: `SELECT 1;`,
                yaml: `key: value`,
                json: `{\n  "hello": "world"\n}`,
                ts: `const x:number=42;`,
                java: `class Main{public static void main(String[]a){System.out.println("hi");}}`,
                cpp: `#include <iostream>\nint main(){std::cout<<"hi";}`
            };
            const panelDefs = [{
                id: 'html',
                icon: 'fa-brands fa-html5',
                label: 'HTML',
                mode: 'htmlmixed'
            }, {
                id: 'css',
                icon: 'fa-brands fa-css3-alt',
                label: 'CSS',
                mode: 'css'
            }, {
                id: 'js',
                icon: 'fa-brands fa-js',
                label: 'JavaScript',
                mode: 'javascript'
            }, {
                id: 'svg',
                icon: 'fa-regular fa-image',
                label: 'SVG',
                mode: 'xml'
            }, {
                id: 'scss',
                icon: 'fa-brands fa-sass',
                label: 'SCSS',
                mode: 'text/x-scss'
            }, {
                id: 'md',
                icon: 'fa-brands fa-markdown',
                label: 'Markdown',
                mode: 'markdown'
            }, {
                id: 'py',
                icon: 'fa-brands fa-python',
                label: 'Python',
                mode: 'python'
            }, {
                id: 'rb',
                icon: 'fa-solid fa-gem',
                label: 'Ruby',
                mode: 'ruby'
            }, {
                id: 'php',
                icon: 'fa-brands fa-php',
                label: 'PHP',
                mode: 'php'
            }, {
                id: 'sql',
                icon: 'fa-solid fa-database',
                label: 'SQL',
                mode: 'sql'
            }, {
                id: 'yaml',
                icon: 'fa-solid fa-list',
                label: 'YAML',
                mode: 'yaml'
            }, {
                id: 'json',
                icon: 'fa-solid fa-code',
                label: 'JSON',
                mode: 'javascript'
            }, {
                id: 'ts',
                icon: 'fa-solid fa-code',
                label: 'TypeScript',
                mode: 'javascript'
            }, {
                id: 'java',
                icon: 'fa-brands fa-java',
                label: 'Java',
                mode: 'text/x-java'
            }, {
                id: 'cpp',
                icon: 'fa-solid fa-c',
                label: 'C/C++',
                mode: 'text/x-c++src'
            }, {
                id: 'rust',
                icon: 'fa-brands fa-rust',
                label: 'Rust',
                mode: 'rust'
            }]; /** makePanel */
            const makePanel = (def) => {
                const root = qs('#panels');
                const wrap = document.createElement('div');
                wrap.className = 'panel';
                wrap.id = `panel-${def.id}`;
                wrap.innerHTML =
                    `<div class="panel-head"><div class="meta"><i class="${def.icon}"></i><span>${def.label}</span></div><div class="panel-actions"><button class="btn" data-act="copy" title="Copy"><i class="fa-regular fa-copy"></i></button><button class="btn" data-act="download" title="Download"><i class="fa-solid fa-download"></i></button><button class="btn" data-act="clear" title="Clear"><i class="fa-regular fa-trash-can"></i></button></div></div><div class="panel-body"><textarea id="ta-${def.id}"></textarea></div>`;
                root.appendChild(wrap);
                const cm = CodeMirror.fromTextArea(wrap.querySelector('textarea'), {
                    mode: def.mode,
                    theme: 'material-darker',
                    lineNumbers: true,
                    styleActiveLine: true,
                    autoCloseBrackets: true,
                    autoCloseTags: true,
                    tabSize: 2,
                    indentUnit: 2,
                    placeholder: def.label
                });
                const initial = (App.vault.current ? .code ? . [def.id]) ? ? (defaultSnippets[def.id] || '');
                cm.setValue(initial);
                cm.on('change', debounce(() => {
                    ensureCurrent();
                    App.vault.current.code[def.id] = cm.getValue();
                    autosave();
                    if (qs('#autoRun').checked) run()
                }, 400));
                wrap.querySelectorAll('[data-act]').forEach(b => on(b, 'click', () => {
                    const act = b.getAttribute('data-act');
                    if (act === 'copy') {
                        navigator.clipboard.writeText(cm.getValue());
                        toast('Copied')
                    }
                    if (act === 'clear') {
                        if (confirm('Clear this panel?')) cm.setValue('')
                    }
                    if (act === 'download') {
                        downloadText(def.id, cm.getValue())
                    }
                }));
                editors.set(def.id, cm)
            }; /** ensureCurrent */
            const ensureCurrent = () => {
                if (!App.vault.current) {
                    App.vault.current = {
                        id: uid(),
                        name: 'Untitled',
                        layout: 'classic',
                        panels: ['html', 'css', 'js'],
                        code: {}
                    }
                }
            }; /** togglePanel */
            const togglePanel = (id, on) => {
                const el = qs('#panel-' + id);
                if (!el) return;
                el.classList.toggle('hidden', !on);
                if (on) editors.get(id) ? .refresh();
                saveSettings()
            }; /** syncToggleAll */
            const syncToggleAll = () => {
                const boxes = qsa('.toggle-panel');
                qs('#toggleAll').checked = boxes.every(b => b.checked)
            }; /** applyLayout */
            const applyLayout = (kind) => {
                document.body.classList.remove('preset-classic', 'preset-columns', 'preset-stacked');
                destroyCustomSplit();
                if (kind === 'custom') {
                    enableCustomSplit()
                } else {
                    if (kind === 'classic') document.body.classList.add('preset-classic');
                    if (kind === 'columns') document.body.classList.add('preset-columns');
                    if (kind === 'stacked') document.body.classList.add('preset-stacked')
                }
                App.vault.settings.layout = kind;
                autosave()
            }; /** enableCustomSplit */
            let splitInstance = null;
            const enableCustomSplit = () => {
                destroyCustomSplit();
                const lr = qs('#layoutRoot');
                if (!qs('#lrSizer')) {
                    const s = document.createElement('div');
                    s.id = 'lrSizer';
                    s.className = 'resizer';
                    lr.insertBefore(s, lr.children[1])
                }
                splitInstance = Split(['#leftCol', '#lrSizer', '#rightCol'], {
                    sizes: [20, 0, 80],
                    minSize: [260, 0, 320],
                    gutterSize: 6,
                    onDragEnd: () => {
                        editors.forEach(e => e.refresh());
                        autosave()
                    }
                })
            }; /** destroyCustomSplit */
            const destroyCustomSplit = () => {
                if (splitInstance && splitInstance.destroy) {
                    splitInstance.destroy();
                    splitInstance = null;
                    const s = qs('#lrSizer');
                    if (s) s.remove()
                }
            }; /** composeDoc */
            const composeDoc = (html, css, js, svg) => {
                const hook =
                    `\n<script>(function(){if(window.__hooked__)return;window.__hooked__=true;function send(t,a){parent.postMessage({type:t,args:Array.from(a)},'*')}['log','info','warn','error'].forEach(k=>{const o=console[k].bind(console);console[k]=function(){send(k,arguments);o.apply(console,arguments)}});window.addEventListener('error',e=>{send('error',[e.message+' @'+(e.filename||'')+':'+(e.lineno||'')])});})();<\/script>`;
                return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.css"><style>${css}</style></head><body>${svg}${html}<script>${js}<\/script>${hook}</body></html>`
            }; /** run */
            const run = () => {
                buildSCSS().then(scssCSS => {
                    const html = (editors.get('html') ? .getValue() || '');
                    const css = (editors.get('css') ? .getValue() || '') +
                        "\n/* ---- compiled from SCSS ---- */\n" + (scssCSS || '');
                    const js = (editors.get('js') ? .getValue() || '');
                    const svg = qs('#panel-svg') ? .classList.contains('hidden') ? '' : (editors.get(
                        'svg') ? .getValue() || '');
                    const doc = composeDoc(html, css, js, svg);
                    qs('#console').innerHTML = '';
                    qs('#preview').srcdoc = doc;
                    setTimeout(() => {
                        try {
                            qs('#preview').contentWindow.__hookConsole__ = true
                        } catch (e) {}
                    }, 50)
                })
            }; /** buildSCSS */
            const buildSCSS = async () => {
                const scss = editors.get('scss') ? .getValue() || '';
                if (!scss.trim()) return '';
                try {
                    return Sass.compile(scss).text
                } catch (e) {
                    log('warn', 'SCSS error: ' + e.message);
                    return ''
                }
            }; /** log */
            const log = (type, ...msg) => {
                const line = document.createElement('div');
                line.className = 'log ' + (type === 'log' ? 'info' : type);
                line.textContent = `[${type}] ${msg.join(' ')}`;
                qs('#console').appendChild(line)
            }; /** serializeCurrent */
            const serializeCurrent = () => {
                const code = {};
                editors.forEach((cm, id) => code[id] = cm.getValue());
                const visible = qsa('.toggle-panel').filter(c => c.checked).map(c => c.dataset.panel);
                ensureCurrent();
                App.vault.current.code = code;
                App.vault.current.panels = visible;
                App.vault.current.layout = qs('#layoutSelect').value;
                return App.vault.current
            }; /** saveProjectSnapshot */
            const saveProjectSnapshot = () => {
                ensureCurrent();
                const idx = App.vault.projects.findIndex(p => p.id === App.vault.current.id);
                if (idx >= 0) App.vault.projects[idx] = serializeCurrent();
                else App.vault.projects.push(serializeCurrent());
                autosave();
                toast('Saved');
                if (App.vault.settings.autoBackup) backupIfPossible('manual save')
            }; /** getProjects */
            const getProjects = () => App.vault.projects; /** setProjects */
            const setProjects = (arr) => {
                App.vault.projects = arr;
                autosave()
            }; /** autosave */
            const autosave = () => {
                saveSettings();
                saveVault()
            }; /** saveSettings */
            const saveSettings = () => {
                App.vault.settings.theme = qs('#themeSel') ? .value || App.vault.settings.theme;
                App.vault.settings.gateExternal = qs('#gateExternal') ? .checked || false;
                App.vault.settings.disabled = qs('#disabledToggle') ? .checked || false;
                App.vault.settings.layout = qs('#layoutSelect') ? .value || App.vault.settings.layout;
                App.vault.settings.panels = qsa('.toggle-panel').filter(c => c.checked).map(c => c.dataset.panel);
                App.vault.settings.autoBackup = qs('#autoBackup') ? .checked || false
            }; /** applySnapshotToEditors */
            const applySnapshotToEditors = () => {
                panelDefs.forEach(def => {
                    const v = App.vault.current ? .code ? . [def.id] ? ? defaultSnippets[def.id] ? ? '';
                    editors.get(def.id) ? .setValue(v)
                });
                qsa('.toggle-panel').forEach(c => {
                    const on = (App.vault.settings.panels || ['html', 'css', 'js']).includes(c.dataset
                        .panel);
                    c.checked = on;
                    togglePanel(c.dataset.panel, on)
                });
                syncToggleAll();
                qs('#layoutSelect').value = App.vault.settings.layout || 'classic';
                applyLayout(qs('#layoutSelect').value)
            }; /** downloadText */
            const downloadText = (kind, text) => {
                const nameMap = {
                    html: 'index.html',
                    css: 'styles.css',
                    js: 'script.js',
                    svg: 'graphic.svg',
                    scss: 'styles.scss',
                    md: 'README.md',
                    py: 'script.py',
                    rb: 'script.rb',
                    php: 'index.php',
                    sql: 'query.sql',
                    yaml: 'config.yml',
                    json: 'data.json',
                    ts: 'script.ts',
                    java: 'Main.java',
                    cpp: 'main.cpp'
                };
                const blob = new Blob([text], {
                    type: 'text/plain;charset=utf-8'
                });
                saveAs(blob, nameMap[kind] || ('code-' + kind + '.txt'))
            }; /** exportZip */
            const exportZip = async () => {
                const zip = new JSZip();
                const html = editors.get('html') ? .getValue() || '';
                const css = (editors.get('css') ? .getValue() || '') + "\n/* compiled SCSS */\n" + (
                    await buildSCSS());
                const js = editors.get('js') ? .getValue() || '';
                const svg = editors.get('svg') ? .getValue() || '';
                const index = composeDoc(html, css, js, svg);
                zip.file('index.html', index);
                zip.file('src/html.html', html);
                zip.file('src/styles.css', css);
                zip.file('src/script.js', js);
                if (svg) zip.file('src/graphic.svg', svg);
                const blob = await zip.generateAsync({
                    type: 'blob'
                });
                saveAs(blob, (App.vault.current ? .name || 'codenest') + '.zip')
            }; /** shareProject */
            const shareProject = async () => {
                const html = editors.get('html') ? .getValue() || '';
                const css = (editors.get('css') ? .getValue() || '') + "\n/* compiled SCSS */\n" + (
                    await buildSCSS());
                const js = editors.get('js') ? .getValue() || '';
                const svg = editors.get('svg') ? .getValue() || '';
                const index = composeDoc(html, css, js, svg);
                const blob = new Blob([index], {
                    type: 'text/html;charset=utf-8'
                });
                saveAs(blob, (App.vault.current ? .name || 'project') + '.standalone.html')
            }; /** openProjects */
            const openProjects = () => {
                qs('#projName').value = App.vault.current ? .name || 'Untitled Project';
                refreshProjectList();
                openModal('projectsModal')
            }; /** refreshProjectList */
            const refreshProjectList = () => {
                const list = qs('#projList');
                list.innerHTML = '';
                for (const p of getProjects()) {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = `${p.name} â€” ${p.id}`;
                    list.appendChild(opt)
                }
            }; /** openModal */
            const openModal = (id) => qs('#' + id).classList.add('open'); /** closeModal */
            const closeModal = (id) => qs('#' + id).classList.remove('open'); /** debounce */
            const debounce = (fn, wait) => {
                let t;
                return (...a) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...a), wait)
                }
            }; /** ---------- Events & Wiring ---------- */
            window.addEventListener('message', (e) => {
                const {
                    type,
                    args
                } = e.data || {};
                if (!type) return;
                const line = document.createElement('div');
                line.className = 'log ' + (type === 'log' ? 'info' : type);
                line.textContent = '[' + type + '] ' + (args || []).map(x => typeof x === 'object' ? JSON
                    .stringify(x) : String(x)).join(' ');
                qs('#console').appendChild(line);
                qs('#console').scrollTop = qs('#console').scrollHeight
            });
            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    openProjects()
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    run()
                }
            });
            document.addEventListener('click', e => {
                const id = e.target.getAttribute('data-close');
                if (id) closeModal(id)
            });
            document.addEventListener('DOMContentLoaded', () => {
                loadConsent();
                if (App.consent === 'unknown') route('page-consent');
                else route('page-auth');
                on(qs('#consent-persist'), 'click', () => {
                    setConsent('persist');
                    toast('Persistent storage enabled')
                });
                on(qs('#consent-session'), 'click', () => {
                    setConsent('session');
                    toast('Session-only storage')
                });
                on(qs('#consent-deny'), 'click', () => {
                    setConsent('memory');
                    toast('Ephemeral mode')
                });
                on(qs('#to-auth'), 'click', () => route('page-auth'));
                on(qs('#auth-to-register'), 'click', () => qs('#reg-user').focus());
                on(qs('#register-btn'), 'click', async () => {
                    const u = qs('#reg-user').value.trim();
                    const p = qs('#reg-pass').value;
                    const p2 = qs('#reg-pass2').value;
                    if (p !== p2) {
                        qs('#auth-msg').textContent = 'Passwords do not match';
                        return
                    }
                    try {
                        await createAccount(u, p);
                        qs('#auth-msg').textContent = 'Account created. Please login.';
                        toast('Account created')
                    } catch (err) {
                        qs('#auth-msg').textContent = err.message
                    }
                });
                on(qs('#login-btn'), 'click', async () => {
                    const u = qs('#login-user').value.trim();
                    const p = qs('#login-pass').value;
                    try {
                        await login(u, p);
                        route('page-app');
                        bootstrapAppUI();
                        ensureBackupLoaded();
                        toast('Welcome ' + u)
                    } catch (err) {
                        qs('#auth-msg').textContent = err.message
                    }
                })
            }); /** bootstrapAppUI */
            const bootstrapAppUI = () => {
                qs('#panels').innerHTML = '';
                editors.clear();
                panelDefs.forEach(makePanel);
                qsa('#toggleAll, .toggle-panel').forEach(el => {
                    on(el, 'change', () => {
                        if (el.id === 'toggleAll') {
                            const onAll = el.checked;
                            qsa('.toggle-panel').forEach(c => {
                                c.checked = onAll;
                                togglePanel(c.dataset.panel, onAll)
                            })
                        } else {
                            togglePanel(el.dataset.panel, el.checked);
                            syncToggleAll()
                        }
                    })
                });
                on(qs('#layoutSelect'), 'change', () => applyLayout(qs('#layoutSelect').value));
                on(qs('#runBtn'), 'click', run);
                on(qs('#openInNew'), 'click', () => {
                    buildSCSS().then(scssCSS => {
                        const html = composeDoc(editors.get('html') ? .getValue() || '', (editors
                                .get('css') ? .getValue() || '') + scssCSS, editors.get('js') ?
                            .getValue() || '', editors.get('svg') ? .getValue() || '');
                        const w = window.open();
                        w.document.write(html);
                        w.document.close()
                    })
                });
                on(qs('#saveBtn'), 'click', openProjects);
                on(qs('#projectsBtn'), 'click', openProjects);
                on(qs('#zipBtn'), 'click', exportZip);
                on(qs('#shareBtn'), 'click', shareProject);
                on(qs('#projSave'), 'click', () => {
                    ensureCurrent();
                    App.vault.current.name = qs('#projName').value || 'Untitled';
                    saveProjectSnapshot();
                    refreshProjectList()
                });
                on(qs('#projLoad'), 'click', () => {
                    const id = qs('#projList').value;
                    if (!id) return;
                    const p = getProjects().find(x => x.id === id);
                    if (!p) return;
                    App.vault.current = JSON.parse(JSON.stringify(p));
                    applySnapshotToEditors();
                    toast('Loaded "' + (App.vault.current.name || '') + '"')
                });
                on(qs('#projDup'), 'click', () => {
                    const id = qs('#projList').value;
                    if (!id) return;
                    const p = JSON.parse(JSON.stringify(getProjects().find(x => x.id === id)));
                    if (!p) return;
                    p.id = uid();
                    p.name = p.name + ' (copy)';
                    const all = getProjects();
                    all.push(p);
                    setProjects(all);
                    refreshProjectList();
                    toast('Duplicated')
                });
                on(qs('#projDel'), 'click', () => {
                    const id = qs('#projList').value;
                    if (!id) return;
                    if (!confirm('Delete selected project?')) return;
                    const all = getProjects().filter(x => x.id !== id);
                    setProjects(all);
                    refreshProjectList();
                    toast('Deleted')
                });
                on(qs('#projExport'), 'click', () => {
                    const id = qs('#projList').value || App.vault.current ? .id;
                    const p = (getProjects().find(x => x.id === id)) || App.vault.current;
                    const blob = new Blob([JSON.stringify(p, null, 2)], {
                        type: 'application/json'
                    });
                    saveAs(blob, (p.name || 'project') + '.codenest.json')
                });
                on(qs('#projImportInput'), 'change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const text = await file.text();
                    try {
                        const p = JSON.parse(text);
                        p.id = uid();
                        const all = getProjects();
                        all.push(p);
                        setProjects(all);
                        refreshProjectList();
                        toast('Imported')
                    } catch {
                        alert('Invalid JSON')
                    }
                    e.target.value = ''
                });
                on(qs('#nav-settings'), 'click', () => {
                    qs('#themeSel').value = App.vault.settings.theme;
                    qs('#storageMode').value = App.consent === 'persist' ? 'persist' : (App.consent ===
                        'session' ? 'session' : 'memory');
                    qs('#gateExternal').checked = !!App.vault.settings.gateExternal;
                    qs('#disabledToggle').checked = !!App.vault.settings.disabled;
                    openModal('settingsModal')
                });
                on(qs('#nav-account'), 'click', () => {
                    qs('#autoBackup').checked = !!App.vault.settings.autoBackup;
                    openModal('accountModal')
                });
                on(qs('#exportVault'), 'click', exportEncrypted);
                on(qs('#importVaultFile'), 'change', async (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    try {
                        await importEncrypted(f)
                    } catch (err) {
                        alert(err.message)
                    }
                    e.target.value = ''
                });
                on(qs('#deleteAccount'), 'click', () => {
                    if (!confirm('Delete account and vault?')) return;
                    kvDel(vaultKey(App.user));
                    idbDel(backupKey());
                    const all = loadUsers().filter(x => x.user !== App.user);
                    saveUsers(all);
                    logout()
                });
                on(qs('#logoutBtn'), 'click', logout);
                on(qs('#themeSel'), 'change', () => {
                    App.vault.settings.theme = qs('#themeSel').value;
                    themeApply(App.vault.settings.theme);
                    autosave()
                });
                on(qs('#storageMode'), 'change', () => {
                    const m = qs('#storageMode').value;
                    setConsent(m === 'persist' ? 'persist' : (m === 'session' ? 'session' : 'memory'));
                    toast('Storage mode updated')
                });
                on(qs('#disabledToggle'), 'change', () => {
                    disableUser(App.user, qs('#disabledToggle').checked);
                    autosave();
                    toast('Account ' + (qs('#disabledToggle').checked ? 'disabled' : 'enabled'))
                });
                on(qs('#connectBackup'), 'click', connectBackup);
                on(qs('#backupNow'), 'click', backupNow);
                on(qs('#autoBackup'), 'change', () => {
                    App.vault.settings.autoBackup = qs('#autoBackup').checked;
                    autosave();
                    toast('Auto-backup ' + (App.vault.settings.autoBackup ? 'on' : 'off'))
                });
                ensureCurrent();
                applySnapshotToEditors();
                themeApply(App.vault.settings.theme || 'dark');
                run()
            };
        </script>
</body>

</html>